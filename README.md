# Move_plus telegram-bot

Это бот для помощи при организациии мероприятий на платформе Move_pus.

Установка
=========

Для начала работы нужно создать базу данных.

1) Установите PostgreSQL

2) создайте базу данных и пользователя
   ```shell script
   create user with encrypted password "password"
   create database database_name
   ```
3) Создайту базу данных, выполнив транзакцию в файле db_creation_tr

4) установите python версии 2.7 и выше либо установите [anaconda](https://www.anaconda.com/products/individual), нажав при установке Add to global PATH, 
 и создайте глобальное окружение 
    ```shell script
    conda create -n env_name python=3.6
    ```
5) установите необходимые модули для python
    ```shell script
    activate env_name #если используете окружение анаконды
    pip install pyTelegramBotAPI
    pip install cython vedis
    pip install psycopg2
    pip install pillow
    ```

В данном проекте задействована библиотека  [Vedis](https://vedis-python.readthedocs.io/en/latest/), которая является продолжением базы данных вида ключ-значение Redis 


В данном проекте задействована библиотека  [Vedis](https://vedis-python.readthedocs.io/en/latest/), которая является продолжением базы данных вида ключ-значение Redis 

Принцип алгоритма
-----------------

База: у каждого участника и отправленного им сообщения есть свои уникальные айди,
chat.id и message_id соответственно. Также у каждого  организатора есть атрибут 'reg_state' , который отображает 
готов ли орг в данный момент выселять перваков 

Работа:

   Участник отправляет заявку, а затем подтвержадет ее. После подтверждения бот
   делает:
   1) запрос на создание записи в таблице 'part_leave' с значениями part_id (id того
   человека, который хочет выселиться), part_chat_id(chat.id участника), дата отправления заявки
   2) отправляет всем оргам, у которых статус 'reg_state'==True, сообщение о том, что данный первак хочет выселиться
   (с указанием фио и адреса проживания), одновременно с этим отправялет запрос на создание записей в таблице 
   "msg_delivery", где (важно!) количестве записей= количество оргов, кому пришло сообение о заявке, org_chat_id= chat.id 
   орга, part_chat_d= chat.id участника, который отправил заявку, msg_id= id отправленного оргу сообщения, и дата
   3)если один орг принимает заявку, то у всех остальных выселяющих оргов эта заявка пропадает, а выселяющему приходит сообщение о потдверждении
   В это время бот отправляет запрос на изменение в msg_delivery поля 'state' на false у всех тех записей,которые относятся к 
    этому участнику, то есть, сообщения больше не активны
   4) орг принимает комнату, указывает есть ли у человека ключ , бот ставит в part_leave у выселяющегося время окончания выселения и ставит 
   state=true , то есть человек выселен 

Благодарности
-------------

Отдельная благодарность Л.Авагян, Л.Миракян за помощь во время дебага бота.
